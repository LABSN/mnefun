version: 2
jobs:
  build_docs:
    docker:
      - image: cimg/base:stable-20.04
    steps:
      # Get our data and merge with upstream
      - checkout
      - run:
          name: Setup system
          command: |
            set -e
            echo "set -e" >> $BASH_ENV
            sudo apt update -qq
            sudo apt install -qq graphviz-dev graphviz python3-venv python3.9-venv python3.9-dev
            python3.9 -m venv ~/python_env
            source ~/python_env/bin/activate
            echo "source ~/python_env/bin/activate" >> $BASH_ENV
            mkdir -p ~/.local/bin
            ln -s ~/python_env/bin/python ~/.local/bin/python
      - run:
          name: Setup Python env
          command: |
            echo "Pip..."
            pip install --quiet --upgrade pip
            echo "Dependencies..."
            pip install --quiet --upgrade numpy scipy https://github.com/mne-tools/mne-python/zipball/main numpydoc sphinx sphinx_fontawesome sphinx_bootstrap_theme
            echo "PyGraphViz..."
            pip install --upgrade pygraphviz
            python -c "import mne; mne.sys_info()"
            pip install -ve .
      - run:
          name: Build docs
          command: |
            make -C doc html

      - store_artifacts:
          path: doc/_build/html/
          destination: html

      - persist_to_workspace:
          root: doc/_build
          paths:
            - html


  deploy:
    docker:
      - image: cimg/base:stable-20.04
    steps:
      - add_ssh_keys:
          fingerprints:
            # ssh-keygen -t rsa -b 4096 -m PEM -C "circle@labsn.github.io"
            - fd:c7:7b:64:4c:35:25:a9:94:b4:bf:51:35:ee:22:e7
      - attach_workspace:
          at: /tmp/_build
      - run:
          name: upload
          command: |
            echo "Deploying docs."
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            touch ~/.ssh/known_hosts
            chmod 600 ~/.ssh/*
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            git clone git@github.com:/LABSN/labsn.github.io.git ~/labsn.github.io --depth=1
            git config --global user.email "circle@labsn.github.io"
            git config --global user.name "Circle CI"
            cd ~/labsn.github.io
            git checkout main
            git pull origin main
            rm -Rf ~/labsn.github.io/mnefun
            cp -a /tmp/_build/html ~/labsn.github.io/mnefun
            git add -A
            git commit --allow-empty -m "CircleCI update of docs (${CIRCLE_BUILD_NUM})."
            git push origin main

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_docs
      - deploy:
          requires:
            - build_docs
          filters:
            branches:
              only: main
